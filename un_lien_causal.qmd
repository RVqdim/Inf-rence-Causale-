---
title: "un_lien_causal"
format: html
editor: visual
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
    toc: true
    toc_depth: 3
    number_sections: true
    df_print: paged
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
    highlight: tango
---

```{r}
library(dplyr)
library(tibble)
library(car)
library(ComplexHeatmap)
library(circlize) 
```

## Idée / contexte

L'idée de ce qmd et de trouver un moyen de mettre en évidence un lien causal entre un SNP et une métabolite ou un groupe de SNP et un groupe de métabolites

voici les groupes dont on sait qu'il y a un lien causal

Le groupe de SNP : Bn.A09.p2733282, Bn.A03.p6484137, Bn.C2.p51343986 et Bn.C7.p38504198 Et le groupe de métabolites : Progoitrin (G7), epiprogoitrin (G8), glucobrassicanapin (G11), et gluconapoleiferin (G12)

Le groupe de SNP : Bn.A04.p2542000, Bn.C3.p1524306, Bn.C3.p3111862, Bn.C3.p6640991, et Bn.C4.p35007222 Et le groupe de métabolites : G30 : Pent i, G31 : 3mPen, G32 : Hex i1, G34 : Hept i1

## nettoyage des données


```{r}
load("data_metabo_rep1.Rdata")
load("data_microbio_rep1.Rdata")
load("geno_numeric.Rdata")
```

### bloc 1

```{r}
snp_cols <- c("Bn.A09.p2733282", "Bn.A03.p6484137", "Bn.C2.p51343986", "Bn.C7.p38504198")
metabo_cols <- c("G7_Progoitrin_(nmol_g-1_DW)", "G8_Epiprogoitrin_(nmol_g-1_DW)", "G11_Glucobrassicanapin_(nmol_g-1_DW)", "G12_Gluconapoleiferin_(nmol_g-1_DW)")
```

premiere chose on vérifie que les snp demandés sont bien dans geno_numeric

```{r}

snp_presents <- intersect(snp_cols, rownames(geno_numeric))
print("--- DIAGNOSTIC DES SNP ---")
if(length(snp_presents) == 0) {
  stop("ERREUR CRITIQUE : Aucun des 4 SNP n'est présent dans le fichier génotype !")
} else {
  print(paste("SNP trouvés et utilisés :", length(snp_presents), "sur", length(snp_cols)))
  print(snp_presents)
  
  missing <- setdiff(snp_cols, snp_presents)
  if(length(missing) > 0) print(paste("SNP manquants (exclus de l'analyse) :", paste(missing, collapse=", ")))
}
```

```{r}
geno_subset <- (geno_numeric[snp_presents, , drop=FALSE]) # On ne prend que les lignes existantes
rownames(geno_subset) <- snp_presents # On s'assure que les noms de colonnes sont corrects
```

Pour utiliser notre modèle mlm on veut fusionner le jeu de données qui contient les SNP et celui qui contient les métabolites au format tibble

```{r}
#On met au format tibble geno
geno_ready <- as_tibble(t(geno_subset), rownames = NA) %>%
  rownames_to_column(var = "ID")

#On met au format tibble metabo déja fait avant
metabo_ready <- as_tibble(data_metabo_rep1, rownames = NA) %>%
  rownames_to_column(var = "ID")

#FUSION
geno_metabo_final <- inner_join(geno_ready, metabo_ready, by = "ID")
```

On renomme les SNP car les caractères spéciaux "\_","-" compliquent notre affaire

```{r}
geno_metabo_clean <- geno_metabo_final %>%
  rename(
    G7 = `G7_Progoitrin_(nmol_g-1_DW)`,
    G8 = `G8_Epiprogoitrin_(nmol_g-1_DW)`,
    G11 = `G11_Glucobrassicanapin_(nmol_g-1_DW)`,
    G12 = `G12_Gluconapoleiferin_(nmol_g-1_DW)`
  )
```

### bloc 2

```{r}
snp_cols2 <- c("Bn.A04.p2542000", "Bn.C3.p1524306", "Bn.C3.p3111862", "Bn.C3.p6640991","Bn.C4.p35007222")
metabo_cols2 <- c("G30_Pentyl-GLS_isomer_(nmol_g-1_DW)", "G31_3-methylpentyl-GLS_(nmol_g-1_DW)", "G32_Hexyl-GLS_isomer_I_(nmol_g-1_DW)", "G34_Heptyl-GLS_isomer_I_(nmol_g-1_DW)")
```

```{r}

snp_presents2 <- intersect(snp_cols2, rownames(geno_numeric))
print("--- DIAGNOSTIC DES SNP ---")
if(length(snp_presents2) == 0) {
  stop("ERREUR CRITIQUE : Aucun des 5 SNP n'est présent dans le fichier génotype !")
} else {
  print(paste("SNP trouvés et utilisés :", length(snp_presents2), "sur", length(snp_cols2)))
  print(snp_presents2)
  
  missing <- setdiff(snp_cols2, snp_presents2)
  if(length(missing) > 0) print(paste("SNP manquants (exclus de l'analyse) :", paste(missing, collapse=", ")))
}
```

```{r}
geno_subset2 <- (geno_numeric[snp_presents2, , drop=FALSE]) # On ne prend que les lignes existantes
rownames(geno_subset2) <- snp_presents2 # On s'assure que les noms de colonnes sont corrects

```

```{r}
#On met au format tibble geno
geno_ready2 <- as_tibble(t(geno_subset2), rownames = NA) %>%
  rownames_to_column(var = "ID")

#On met au format tibble metabo
metabo_ready <- as_tibble(data_metabo_rep1, rownames = NA) %>%
  rownames_to_column(var = "ID")

#FUSION
geno_metabo_final2 <- inner_join(geno_ready2, metabo_ready, by = "ID")
```

```{r}
geno_metabo_clean2 <- geno_metabo_final2 %>%
  rename(
    G30 = `G30_Pentyl-GLS_isomer_(nmol_g-1_DW)`,
    G31 = `G31_3-methylpentyl-GLS_(nmol_g-1_DW)`,
    G32 = `G32_Hexyl-GLS_isomer_I_(nmol_g-1_DW)`,
    G34 = `G34_Heptyl-GLS_isomer_I_(nmol_g-1_DW)`
  )
```



## Matrice variance-covariance

```{r}
# Fonction de couleur pour les CORRÉLATIONS (-1 à 1)
# Bleu = Anticorrélation, Blanc = Nul, Rouge = Corrélation forte
col_corr <- colorRamp2(c(-1, 0, 1), c("blue", "white", "red"))

# Fonction pour afficher les valeurs dans les cases (optionnel, utile si peu de variables)
cell_fun_label <- function(j, i, x, y, width, height, fill, mat) {
    grid.text(sprintf("%.2f", mat[i, j]), x, y, gp = gpar(fontsize = 10))
}
```

pour les metabos

```{r}
# Nettoyage des données 
metabo_clean <- na.omit(data_metabo_rep1)
metabo_mat <- as.matrix(metabo_clean)

# Calcul des variances
variances <- apply(metabo_mat, 2, var, na.rm = TRUE)
cols_zero_var <- names(variances[variances == 0 | is.na(variances)])

cat("Colonnes à variance nulle ou NA retirées :\n")
print(cols_zero_var)

# On ne garde que les colonnes valides
metabo_mat_clean <- metabo_mat[, variances > 0 & !is.na(variances)]

# Matrice de corrélation
metabo_cor <- cor(metabo_mat_clean, use = "pairwise.complete.obs")

# Matrice de covariance
metabo_cov <- cov(metabo_mat_clean)

# Création des noms courts (après avoir nettoyé la matrice)
noms_courts <- sub("_.*", "", colnames(metabo_mat_clean))

Heatmap(metabo_cor, 
        name = "Corrélation", 
        col = col_corr,
        column_title = "Matrice de Corrélation (Tous Métabolites)",
        row_labels = noms_courts,
        column_labels = noms_courts,
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 8),
        # Clustering (pour regrouper les métabolites qui se ressemblent)
        cluster_rows = TRUE,
        cluster_columns = TRUE
)


# On adapte l'échelle de couleur au maximum de covariance observée.
max_cov <- max(abs(metabo_cov))
col_cov <- colorRamp2(c(min(metabo_cov),mean(metabo_cov),max(metabo_cov)), c("blue", "white", "red"))

Heatmap(metabo_cov, 
        name = "Covariance",
        col = col_cov,
        column_title = "Matrice de Covariance (Tous Métabolites)",
        
        row_labels = noms_courts,
        column_labels = noms_courts,
        
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 8)
)
```

Pour le premier groupe ou il y a causalité entre les SNP et les métabos

```{r}
# --- Préparation des données Groupe 1 ---
geno_ready_mat <- geno_ready %>% 
  select(where(is.numeric)) %>% 
  na.omit() %>% 
  as.matrix()

# Sélection et nettoyage des noms pour les métabolites
metabo_ready_mat <- metabo_ready %>% 
  select("G7_Progoitrin_(nmol_g-1_DW)", "G8_Epiprogoitrin_(nmol_g-1_DW)", 
         "G11_Glucobrassicanapin_(nmol_g-1_DW)", "G12_Gluconapoleiferin_(nmol_g-1_DW)")  

# Raccourcir les noms (G7, G8...) pour l'affichage
colnames(metabo_ready_mat) <- substr(colnames(metabo_ready_mat), 1, 3) 
metabo_ready_mat <- as.matrix(metabo_ready_mat)

# --- Heatmaps SNPs Groupe 1 ---
# Covariance (L'échelle de couleur doit s'adapter aux données max/min)
cov_snp1 <- cov(geno_ready_mat)
Heatmap(cov_snp1, 
        name = "Covariance", 
        column_title = "Covariance SNPs (Groupe 1)",
        cluster_rows = FALSE, cluster_columns = FALSE) # Pas de clustering sur les SNPs si l'ordre importe

# Corrélation
cor_snp1 <- cor(geno_ready_mat)
Heatmap(cor_snp1, 
        name = "Correlation", 
        col = col_corr,
        column_title = "Corrélation SNPs (Groupe 1)",
        cell_fun = function(j, i, x, y, width, height, fill) {
            grid.text(sprintf("%.2f", cor_snp1[i, j]), x, y, gp = gpar(fontsize = 8))
        })

# --- Heatmaps Métabolites Groupe 1 ---
cov_met1 <- cov(metabo_ready_mat)
Heatmap(cov_met1, 
        name = "Covariance", 
        column_title = "Covariance Métabolites (Groupe 1)")

cor_met1 <- cor(metabo_ready_mat)
Heatmap(cor_met1, 
        name = "Correlation", 
        col = col_corr, 
        column_title = "Corrélation Métabolites (Groupe 1)",
        cell_fun = function(j, i, x, y, width, height, fill) {
            grid.text(sprintf("%.2f", cor_met1[i, j]), x, y, gp = gpar(fontsize = 8))
        })

```



```{r}

# --- Préparation des données Groupe 2 ---
geno_ready_mat2 <- geno_ready2 %>% 
  select(where(is.numeric)) %>% 
  na.omit() %>% 
  as.matrix()

metabo_ready_mat2 <- metabo_ready %>% 
  select("G30_Pentyl-GLS_isomer_(nmol_g-1_DW)",
         "G31_3-methylpentyl-GLS_(nmol_g-1_DW)",
         "G32_Hexyl-GLS_isomer_I_(nmol_g-1_DW)",
         "G34_Heptyl-GLS_isomer_I_(nmol_g-1_DW)")  

colnames(metabo_ready_mat2) <- substr(colnames(metabo_ready_mat2), 1, 3)
metabo_ready_mat2 <- as.matrix(metabo_ready_mat2)

# --- Heatmaps SNPs Groupe 2 ---
Heatmap(cov(geno_ready_mat2), 
        name = "Variance covariance", 
        column_title = "Variance Covariance SNPs (Groupe 2)",
        cell_fun = function(j, i, x, y, width, height, fill) {
             grid.text(sprintf("%.2f", cor_snp2[i, j]), x, y, gp = gpar(fontsize = 8))
        }
        )


cor_snp2 <- cor(geno_ready_mat2)
Heatmap(cor_snp2, 
        name = "Correlation", 
        col = col_corr,
        column_title = "Corrélation SNPs (Groupe 2)",
        cell_fun = function(j, i, x, y, width, height, fill) {
             grid.text(sprintf("%.2f", cor_snp2[i, j]), x, y, gp = gpar(fontsize = 8))
        })

# --- Heatmaps Métabolites Groupe 2 ---
cor_met2 <- cor(metabo_ready_mat2)
Heatmap(cor_met2, 
        name = "Correlation", 
        col = col_corr,
        column_title = "Corrélation Métabolites (Groupe 2)",
        cell_fun = function(j, i, x, y, width, height, fill) {
             grid.text(sprintf("%.2f", cor_met2[i, j]), x, y, gp = gpar(fontsize = 8))
        })
Heatmap(cov(metabo_ready_mat2), name = "variance covariance metabo groupe 2")
```


